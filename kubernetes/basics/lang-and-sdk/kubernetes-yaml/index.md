---
metaTitle: Работа с YAML в Kubernetes
metaDescription: Полное руководство по работе с YAML в Kubernetes - структура манифестов, редактирование, создание, лучшие практики и разбор типичных ошибок
author: Олег Марков
title: Работа с YAML в Kubernetes
preview: Научитесь создавать и использовать YAML-манифесты в Kubernetes - от описания деплойментов до корректного обновления конфигураций и поиска ошибок
---

## Введение

Kubernetes — система оркестрации контейнеров, которая широко используется для управления развертыванием, масштабированием и эксплуатацией приложений. Один из центральных способов взаимодействия с его объектами — использование манифестов в формате YAML. Именно через YAML-файлы вы описываете, что должно происходить в кластере: какие приложения запускать, как настраивать сеть, ограничивать доступ, определять политику обновления, хранить секреты и многое другое.

В этой статье я объясню, как устроен YAML, покажу примеры типичных и продвинутых манифестов, разберу особенности формата и работы с ним в kubectl, дам советы, как не наломать дров из-за ошибок синтаксиса, и покажу лайфхаки, которые сделают вашу работу более безопасной и удобной.

## Что такое YAML и зачем он нужен в Kubernetes

YAML (Yet Another Markup Language, официально — YAML Ain’t Markup Language) — человекочитаемый формат сериализации данных. Главное его преимущество для Kubernetes — ясность, лаконичность, поддержка структуры вложенности, комментариев и массивов. Все эти свойства позволяют просто и наглядно описывать даже сложные конфигурации ваших приложений и инфраструктуры.

В Kubernetes через YAML вы определяете:

* Deployment, StatefulSet, Pod и другие рабочие нагрузки
* Сервисы и ингрессы
* Volumes, ConfigMap, Secret
* RBAC-права, сервисные аккаунты
* Любые другие объекты API

Для примера: вот базовая структура YAML-манифеста для Deployment:

```yaml
apiVersion: apps/v1        # Версия API
kind: Deployment           # Тип объекта
metadata:
  name: nginx-deployment   # Имя объекта
  labels:                  # Набор меток
    app: nginx
spec:                      # Описание желаемого состояния
  replicas: 3              # Число копий подов
  selector:                
    matchLabels:
      app: nginx
  template:                # Шаблон пода
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.17
```

Теперь давайте последовательно разберём все элементы работы с YAML в Kubernetes.

## Структура и синтаксис YAML. Что важно знать

### Форматирование и отступы

YAML использует только пробелы для определения уровня вложенности (табуляция не допускается). Нарушение этого правила — частая причина ошибок при применении манифестов.

Пример корректного отступа:

```yaml
spec:
  containers:
    - name: nginx
      image: nginx:latest
```
Здесь `containers` — массив, каждый элемент массива выделяется тире и уходит на уровень вложенности глубже.

### Комментарии

Комментарии начинаются с `#`. Советуем использовать их для пояснения непонятных частей манифеста.

```yaml
replicas: 2 # Запустим два пода с этим шаблоном
```

### Скалярные значения и списки

Числа, строки, логические значения, null — всё представляется как есть.

```yaml
stringData: simple
number: 10
boolean: true
isEmpty: null
```

Список обозначается через `-`:

```yaml
ports:
  - containerPort: 80
  - containerPort: 443
```

Запомните: разночтения в синтаксисе (наличие лишних пробелов, смешение списков и объектов) приводят к недопустимым или неожиданным манифестам.

### Обязательные поля манифеста Kubernetes

Всегда присутствуют:

* `apiVersion` — версия API, важна для совместимости
* `kind` — тип описываемого объекта
* `metadata` — метаданные, включая имя ресурса
* `spec` — спецификация (желательное состояние и параметры)

## Работа с базовыми объектами Kubernetes

Давайте рассмотрим частые типы манифестов и их структуру.

### Deployment — развертывание приложения

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
        - name: mycontainer
          image: busybox
          command: ["sleep", "3600"]
```

Что происходит здесь: вы объявляете, что желаете запустить два пода (`replicas: 2`), каждый из которых будет работать на основе `busybox` и выполнять команду `sleep 3600`.

### Service — публикация приложения

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: myapp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
```

Service связывает запросы на порт 80 внутри кластера с конкретными подами, найденными по метке `app: myapp`. `type: ClusterIP` делает сервис доступным лишь внутри кластера.

### ConfigMap и Secret

Манифесты для хранения конфигураций и секретных данных.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  DB_HOST: "db.prod"
  CACHE_TIMEOUT: "600"
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  password: cGFzc3dvcmQ=   # password в base64
```
Данные в Secret всегда кодируются в base64.

### RBAC — права доступа

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: pod-reader
rules:
  - apiGroups: [""]        # "" указывает на core API group
    resources: ["pods"]
    verbs: ["get", "watch", "list"]
```

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: default
subjects:
  - kind: User
    name: jane
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

## Использование Kubectl для работы с YAML

### Применение и удаление манифестов

С помощью утилиты kubectl вы можете применять манифесты напрямую:

```bash
kubectl apply -f deployment.yaml   # Добавить или обновить объект
kubectl delete -f deployment.yaml  # Удалить объект, описанный в YAML
```

### Получение YAML существующего объекта

Можно посмотреть YAML-описание уже созданного ресурса:

```bash
kubectl get deployment myapp -o yaml
```

Это удобно для создания новых манифестов на основе уже работающих.

### Создание шаблонов

Чтобы получить шаблон манифеста:

```bash
kubectl create deployment nginx --image=nginx:1.21 --dry-run=client -o yaml > nginx-deploy.yaml
```
Опция `--dry-run=client` предотвращает реально создание ресурса, а вот вывод в формате YAML сохраняется в файл.

### Валидация манифестов

Проверить синтаксис и возможность применить YAML:

```bash
kubectl apply --dry-run=client -f deployment.yaml
```

## Продвинутые техники и типовые ошибки

### Обработка нескольких объектов в одном файле

Возможность описывать сразу несколько ресурсов через разделитель:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
```
`---` разделяет отдельные объекты в одном файле.

### Использование аннотаций

Аннотации (`annotations`) применяются для произвольных метаданных. Например:

```yaml
metadata:
  annotations:
    description: "Этот деплоймент для тестового окружения"
```

### Переиспользование и шаблоны (kustomize, Helm)

Обычный YAML — статичный, но при использовании инструментов вроде kustomize или Helm вы сможете создавать шаблоны и накладывать патчи.

#### kustomize

Можно переопределять отдельные поля или добавлять новые:

```bash
kubectl kustomize ./overlays/dev | kubectl apply -f -
```

#### Helm

Позволяет создавать настраиваемые по значениям чарт-файлы на основе шаблонов:

```bash
helm install my-release ./mychart
```

В шаблонах используются конструкции вида `{{ .Values.someVar }}`.

### Интеграция с системами контроля версий

Рекомендуется хранить YAML-манифесты в git-репозиториях для отслеживания изменений и удобного отката.

### Частые ошибки новичков

- Нарушение отступов и смешение табуляции и пробелов
- Несовпадение apiVersion (например, старые версии для новых кластеров)
- Ошибки при указании селекторов подов (результат — сервис не находит поды)
- Неочевидные последствия обновления вручную (например, случайный сброс меток)

Вот такой YAML мог бы вызвать ошибку из-за неверных отступов:

```yaml
containers:
- name: app
  image: myapp:v1
    ports:
      - containerPort: 8080   # Лишний отступ!
```
kubectl выдаст ошибку parsing, но строка ошибки не всегда сразу указывает на причину.

## Лучшие практики работы с YAML в Kubernetes

- Старайтесь давать осмысленные имена объектам и меткам, избегайте случайных названий.
- Используйте одинаковые ключи меток (например, `app`, `environment`), это облегчит автоматизацию и селекцию ресурсов.
- Разносите однозначно связанные между собой объекты (например, Deployment и Service) по одному файлу через разделитель `---`.
- Сохраняйте манифесты в git, а изменения — в pull request’ах. Так проще контролировать историю и избегать незапланированных изменений.
- Постоянно прогоняйте манифесты через команду dry-run перед применением: `kubectl apply --dry-run=client -f ...`
- Для сложных проектов внедряйте Helm или kustomize, чтобы избежать дублирования YAML и повысить гибкость управления окружениями.

## Заключение

YAML является важнейшим инструментом управления инфраструктурой на Kubernetes. Именно с его помощью вы определяете состояние кластера, взаимодействуете с API и автоматизируете процессы развертывания и сопровождения сервисов. Освоив структуру YAML-манифестов, основные типы объектов и научившись избегать типичных ошибок, вы снизите риски сбоев и упростите эксплуатацию приложений. Не забывайте об инструментах для шаблонизации и валидации, храните файлы в системе контроля версий и постоянно совершенствуйте подходы к созданию ваших инфраструктурных кодов.

## Частозадаваемые технические вопросы по теме статьи и ответы на них

**1. Как корректно указать несколько контейнеров в одном pod через YAML?**

Укажите массив `containers` в секции `spec`:

```yaml
spec:
  containers:
    - name: app
      image: myapp:latest
    - name: sidecar
      image: mysidecar:latest
```
Для обоих контейнеров могут быть свои порты, переменные окружения, volumeMounts.

**2. Как добавить переменные окружения из ConfigMap в pod-манифесте?**

Используйте `envFrom`:

```yaml
spec:
  containers:
    - name: app
      image: myapp
      envFrom:
        - configMapRef:
            name: app-config
```

**3. Как определить, что объект был создан именно этим YAML?**

В `metadata` добавьте поле `annotations` или уникальные метки:

```yaml
metadata:
  labels:
    managed-by: my-system
  annotations:
    commit-hash: "abcdef"
```

**4. Как объединить несколько YAML-файлов перед применением?**

Используйте:

```bash
kubectl apply -f dir_with_yamls/
# Или объедините файлы в один через cat:
cat file1.yaml file2.yaml > all.yaml
kubectl apply -f all.yaml
```

**5. Как обновить только image у деплоймента без редактирования YAML?**

Выполните:

```bash
kubectl set image deployment/mydeploy mycontainer=repo/newimage:tag
```
Этот способ удобен для программных CI/CD обновлений.